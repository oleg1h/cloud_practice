name: Deploy to Google Cloud Storage

on:
  push:
    branches: [ main ]

env:
  BUCKET_NAME: my-website-demo-oleg
  GCP_PROJECT: halogen-shine-477208-b4

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup GCloud with Service Account
      run: |
        echo "Setting up Google Cloud authentication..."
        # Создаем файл с ключом сервисного аккаунта
        echo '${{ secrets.GCP_SA_KEY }}' > gcp-key.json
        
        # Устанавливаем аутентификацию
        gcloud auth activate-service-account --key-file=gcp-key.json
        gcloud config set project $GCP_PROJECT
        
        # Проверяем аутентификацию
        gcloud auth list

    - name: Configure bucket for website hosting
      run: |
        echo "Configuring bucket for website hosting..."
        gsutil web set -m index.html -e 404.html gs://$BUCKET_NAME
        gsutil uniformbucketlevelaccess set off gs://$BUCKET_NAME
        gsutil iam ch allUsers:objectViewer gs://$BUCKET_NAME

    - name: Deploy files to GCS
      run: |
        echo "Deploying files to bucket: $BUCKET_NAME"
        gcloud storage cp --recursive ./ gs://$BUCKET_NAME/
        echo "Files deployed successfully!"

    - name: Verify deployment
      run: |
        echo "Checking deployed files:"
        gcloud storage ls gs://$BUCKET_NAME/ --recursive
        echo ""
        echo " Website is available at:"
        echo "http://$BUCKET_NAME.storage.googleapis.com"

    - name: Cleanup
      run: |
        rm -f gcp-key.json
        echo "Cleanup completed"